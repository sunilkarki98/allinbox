version: '3.8'

# Production Docker Compose for AllInBox
# Database: Supabase (external managed service)
# Cache: Dragonfly (Redis-compatible, local)
# Backend: Express API
# Workers: BullMQ job processors

networks:
  allinbox_net:
    driver: bridge

volumes:
  dragonfly_data:


services:
  # =====================================================
  # In-Memory Cache & Job Queue
  # =====================================================
  # Note: All job queues and session caching use Dragonfly
  # Database is on Supabase (external managed service)
  # Connect to Supabase via DATABASE_URL env variable
  dragonfly:
    image: 'docker.dragonflydb.io/dragonflydb/dragonfly'
    command: --proactor_threads=4 --default_lua_flags=allow-undeclared-keys --admin_port=8080
    container_name: allinbox_dragonfly
    restart: always
    ulimits:
      memlock: -1
    ports:
      - "6379:6379"
      - "8080:8080"
    volumes:
      - dragonfly_data:/data
    networks:
      - allinbox_net

  # =====================================================
  # Backend API Server
  # =====================================================
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: allinbox_backend
    restart: always
    depends_on:
      - dragonfly
    ports:
      - "3001:3001"
    environment:
      # ===== Database (Supabase) =====
      - DATABASE_URL=${DATABASE_URL}
      # ===== Cache (Local Dragonfly) =====
      - REDIS_URL=redis://dragonfly:6379
      # ===== App Config =====
      - NODE_ENV=production
      - PORT=3001
      - API_URL=${API_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - ADMIN_URL=${ADMIN_URL}
      # ===== Security =====
      - JWT_SECRET=${JWT_SECRET}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      # ===== External APIs =====
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - META_APP_ID=${META_APP_ID:-}
      - META_APP_SECRET=${META_APP_SECRET:-}
      - META_REDIRECT_BASE_URL=${META_REDIRECT_BASE_URL:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:-}
      - WEBHOOK_VERIFY_TOKEN=${WEBHOOK_VERIFY_TOKEN:-}
    networks:
      - allinbox_net
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # =====================================================
  # Background Workers
  # =====================================================
  # Processes: Ingestion, Analysis, Score Decay
  # Consumes jobs from Dragonfly queues
  worker:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: allinbox_worker
    restart: always
    command: npm run start:worker:all
    depends_on:
      - dragonfly
    environment:
      # ===== Database (Supabase) =====
      - DATABASE_URL=${DATABASE_URL}
      # ===== Cache (Local Dragonfly) =====
      - REDIS_URL=redis://dragonfly:6379
      # ===== App Config =====
      - NODE_ENV=production
      # ===== External APIs =====
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - META_APP_ID=${META_APP_ID:-}
      - META_APP_SECRET=${META_APP_SECRET:-}
    networks:
      - allinbox_net
